name: Deploy Spring Boot with Docker to EC2

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Git Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission to Gradle
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Check build directory
        run: ls -l build/libs/

      - name: Debug Current Directory and Build Files
        run: |
          echo "ğŸ“‚ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬:"
          pwd
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ ë‚´ íŒŒì¼ ëª©ë¡:"
          ls -l
          echo "ğŸ“‚ build/libs/ í´ë” í™•ì¸:"
          ls -l build/libs/ || echo "âŒ build/libs/ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"

      - name: Build JAR with Gradle (Force bootJar)
        run: ./gradlew bootJar

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        working-directory: ${{ github.workspace }}
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/inkstone:latest -f Dockerfile .
          docker push ${{ secrets.DOCKER_USERNAME }}/inkstone:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Debug SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r'

      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

      - name: Test SSH Connection
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_HOST }} "echo 'âœ… EC2 SSH ì—°ê²° ì„±ê³µ'"

      - name: Connect to EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ” ê¸°ì¡´ inkstone ì»¨í…Œì´ë„ˆ í™•ì¸..."
            if [ $(sudo docker ps -q -f name=inkstone) ]; then
              echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
              sudo docker stop inkstone
              sudo docker rm inkstone
            else
              echo "âœ… ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."
            fi

            echo "ğŸ“¥ ìµœì‹  Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ..."
            sudo docker pull --quiet ${{ secrets.DOCKER_USERNAME }}/inkstone:latest

            echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            sudo docker run -d --restart always --log-opt max-size=10m --log-opt max-file=3 \
              -p ${{ secrets.EC2_INKSTONE_PORT }}:${{ secrets.EC2_INKSTONE_PORT }} --name inkstone ${{ secrets.DOCKER_USERNAME }}/inkstone:latest

            echo "ğŸ” ë°°í¬ëœ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
            sudo docker ps -a | grep inkstone

            echo "ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬..."
            sleep 5
            curl -X GET http://${{ secrets.EC2_HOST }}:${{ secrets.EC2_INKSTONE_PORT }}/health || echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨!"